<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MultiSearch 350</title>
  <style>
    :root{
      --bg:#dcc3ad; --text:#202124; --muted:#5f6368; --line:#dadce0;
      --shadow: 0 6px 18px rgba(0,0,0,.12);
      --blue:#1a73e8; --chip:#f1f3f4; --danger:#d93025;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
      background:var(--bg);
      color:var(--text);
      display:flex;
      justify-content:center;
      padding: 10px;
    }

    /* 强制所有功能在 350px 内展示 */
    .frame{
      width:min(780px, 100%);
      height:350px;
      border:1px solid rgba(0,0,0,.06);
      border-radius:16px;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .topbar{
      height:44px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 12px;
      border-bottom:1px solid rgba(0,0,0,.06);
      gap:10px;
    }
    .brand{
      font-weight:650;
      letter-spacing:.2px;
      user-select:none;
      white-space:nowrap;
    }
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      min-width: 0;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      max-width: 100%;
    }
    .pill label{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    select, input, button{ font: inherit; }
    select{
      border:none; outline:none; background:transparent; cursor:pointer;
      max-width: 180px;
    }
    .uid{
      border:none; outline:none; width: 130px; min-width: 80px;
    }

    .main{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      /*justify-content:center;*/
      padding: 14px 12px 10px;
      position:relative;
    }

    .wrap{
      width:min(680px, 100%);
      position:relative;
    }
    .bar{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .bar:focus-within{
      border-color: rgba(26,115,232,.35);
      box-shadow: 0 3px 14px rgba(26,115,232,.10);
    }
    .q{
      flex:1 1 auto;
      border:none; outline:none;
      font-size:16px;
      min-width: 0;
    }
    .iconbtn{
      border:none; background:transparent; cursor:pointer;
      padding:6px; border-radius:10px;
    }
    .iconbtn:hover{ background: rgba(0,0,0,.06); }
    .icon{ width:18px; height:18px; fill: var(--muted); }

    .panel{
      position:absolute;
      left:0; right:0;
      top: calc(100% + 8px);
      background:#fff;
      border:1px solid var(--line);
      border-radius: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index: 20;
    }
    .panel.show{ display:block; }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 8px 10px;
      border-bottom:1px solid rgba(0,0,0,.06);
      gap:8px;
    }
    .tabs{
      display:flex;
      gap:6px;
      align-items:center;
      min-width: 0;
    }
    .tab{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(0,0,0,.10);
      background:#fff;
      border-radius:999px;
      padding:3px 8px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color:#fff;
      background: var(--blue);
      border-color: var(--blue);
    }
    .links{
      display:flex;
      gap:10px;
      align-items:center;
      flex: 0 0 auto;
    }
    .link{
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      white-space:nowrap;
    }
    .link:hover{ text-decoration:underline; }
    .link.danger{ color: var(--danger); }

    /* 350px 内关键：下拉最大高度+滚动 */
    .list{
      max-height: 160px;
      overflow:auto;
      padding: 4px 0;
      margin:0;
      list-style:none;
    }
    .item{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 9px 10px;
      cursor:pointer;
    }
    .item:hover, .item.active{ background: rgba(26,115,232,.08); }
    .k{
      flex:1 1 auto;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-size:14px;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      background: var(--chip);
      border-radius:999px;
      padding: 2px 8px;
      flex:0 0 auto;
    }
    .foot{
      height:34px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-top:1px solid rgba(0,0,0,.06);
      color:var(--muted);
      font-size:12px;
      padding: 0 10px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="topbar">
      <div class="brand">MultiSearch</div>

      <div class="controls">
        <div class="pill" title="选择搜索引擎（用于跳转搜索 + 联想源）">
          <label>引擎</label>
          <select id="engine"></select>
        </div>

        <div class="pill" title="跨设备历史同步：在不同电脑使用同一个同步ID即可看到同一份历史">
          <label>同步ID</label>
          <input id="uid" class="uid" placeholder="比如 xiaobe" />
        </div>
      </div>
    </div>

    <div class="main">

      <div class="wrap">
        <div class="bar">
          <input id="q" class="q" autocomplete="off" placeholder="输入要搜索的内容…" />
          <button id="clear" class="iconbtn" title="清空">
            <svg class="icon" viewBox="0 0 24 24"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 1 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.42 1.42L12 13.41l4.89 4.9a1 1 0 0 0 1.42-1.42L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4z"/></svg>
          </button>
          <button id="go" class="iconbtn" title="搜索（回车也可以）">
            <svg class="icon" viewBox="0 0 24 24"><path d="M10 4a6 6 0 1 0 4.472 10.03l3.749 3.75a1 1 0 0 0 1.414-1.415l-3.75-3.749A6 6 0 0 0 10 4zm0 2a4 4 0 1 1 0 8 4 4 0 0 1 0-8z"/></svg>
          </button>
        </div>

        <div class="panel" id="panel">
          <div class="panelHead">
            <div class="tabs">
              <div class="tab active" id="tabSuggest">联想</div>
              <div class="tab" id="tabHistory">历史</div>
            </div>
            <div class="links">
              <a class="link" id="refreshHist">刷新历史</a>
              <a class="link danger" id="clearHist">清空历史</a>
            </div>
          </div>
          <ul class="list" id="list"></ul>
        </div>
      </div>
    </div>
    
    <div class="foot">
      小贝同学自己的搜索工具｜Enter 搜索｜同“同步ID”跨设备共享历史
    </div>
  </div>

<script>
  const ENGINES = [
    { id:"google", name:"Google", url:q=>`https://www.google.com/search?q=${encodeURIComponent(q)}` },
    { id:"bing",   name:"Bing",   url:q=>`https://www.bing.com/search?q=${encodeURIComponent(q)}` },
    { id:"baidu",  name:"百度",   url:q=>`https://www.baidu.com/s?wd=${encodeURIComponent(q)}` },
    { id:"duck",   name:"DuckDuckGo", url:q=>`https://duckduckgo.com/?q=${encodeURIComponent(q)}` },
    { id:"sogou",  name:"搜狗",   url:q=>`https://www.sogou.com/web?query=${encodeURIComponent(q)}` },
    { id:"360",    name:"360搜索", url:q=>`https://www.so.com/s?q=${encodeURIComponent(q)}` }
  ];

  const $ = s => document.querySelector(s);
  const engineSel = $("#engine");
  const uidInput = $("#uid");
  const qInput = $("#q");
  const panel = $("#panel");
  const list = $("#list");
  const tabSuggest = $("#tabSuggest");
  const tabHistory = $("#tabHistory");

  const LS_ENGINE = "ms350.engine.v1";
  const LS_UID = "ms350.uid.v1";

  let mode = "suggest"; // suggest | history
  let items = [];
  let active = -1;
  let lastToken = 0;

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function currentEngine(){
    return ENGINES.find(e=>e.id===engineSel.value) || ENGINES[0];
  }
  function currentUid(){
    const u = (uidInput.value || "default").trim() || "default";
    return u.slice(0,40);
  }

  function setMode(m){
    mode = m;
    tabSuggest.classList.toggle("active", m==="suggest");
    tabHistory.classList.toggle("active", m==="history");
    render();
  }

  function showPanel(){
    panel.classList.add("show");
  }
  function hidePanel(){
    panel.classList.remove("show");
    active = -1;
  }

  function setItems(next){
    items = next;
    active = -1;
    render();
  }

  function render(){
    list.innerHTML = "";
    const show = (mode==="suggest")
      ? items.filter(x=>x.type!=="history")
      : items.filter(x=>x.type==="history");

    if (!show.length){
      const li = document.createElement("li");
      li.className = "item";
      li.innerHTML = `<span class="k" style="color:var(--muted)">暂无${mode==="suggest"?"联想":"历史"}</span>`;
      list.appendChild(li);
      return;
    }

    show.forEach((it, idx) => {
      const li = document.createElement("li");
      li.className = "item" + (idx===active ? " active" : "");
      li.dataset.index = String(idx);
      li.innerHTML = `
        <span class="k">${escapeHtml(it.text)}</span>
        <span class="badge">${escapeHtml(it.badge || "")}</span>
      `;
      li.addEventListener("mousedown", (e)=>{
        e.preventDefault();
        choose(idx);
      });
      list.appendChild(li);
    });
  }

  function choose(idx){
    const show = (mode==="suggest")
      ? items.filter(x=>x.type!=="history")
      : items.filter(x=>x.type==="history");
    const it = show[idx];
    if(!it) return;
    qInput.value = it.text;
    hidePanel();
    doSearch();
  }

  async function apiHistory(){
    const u = encodeURIComponent(currentUid());
    const r = await fetch(`/api/history?u=${u}`);
    return r.json();
  }

  async function apiSuggest(q){
    const u = encodeURIComponent(currentUid());
    const e = encodeURIComponent(engineSel.value);
    const r = await fetch(`/api/suggest?u=${u}&engine=${e}&q=${encodeURIComponent(q)}`);
    return r.json();
  }

  async function loadHistoryToItems(){
    try{
      const data = await apiHistory();
      const hist = (data.items || []).slice(0, 20).map(x=>({
        type:"history",
        text: x.q,
        badge:"历史"
      }));
      // 只更新历史部分，不破坏联想（合并）
      const nonHist = items.filter(x=>x.type!=="history");
      setItems([...nonHist, ...hist]);
      showPanel();
    }catch{
      // ignore
    }
  }

  function mergeSuggestAndHistory(suggestList, historyList){
    const out = [];
    const seen = new Set();
    for(const s of suggestList){
      const t = (s||"").trim();
      if(!t || seen.has(t)) continue;
      seen.add(t);
      out.push({type:"suggest", text:t, badge:"联想"});
      if(out.length>=12) break;
    }
    for(const h of historyList){
      const t = (h?.q||"").trim();
      if(!t || seen.has(t)) continue;
      seen.add(t);
      out.push({type:"history", text:t, badge:"历史"});
      if(out.length>=20) break;
    }
    return out;
  }

  const debouncedSuggest = (() => {
    let t;
    return () => {
      clearTimeout(t);
      t = setTimeout(async () => {
        const q = (qInput.value||"").trim();
        const token = ++lastToken;

        // 为空：直接看历史
        if(!q){
          await loadHistoryToItems();
          setMode("history");
          return;
        }

        try{
          const [sug, hist] = await Promise.all([
            apiSuggest(q),
            apiHistory()
          ]);
          if(token !== lastToken) return;

          const merged = mergeSuggestAndHistory(sug.suggestions || [], hist.items || []);
          setItems(merged);
          setMode("suggest");
          showPanel();
        }catch{
          // 失败也至少展示历史匹配
          await loadHistoryToItems();
          setMode("history");
        }
      }, 160);
    };
  })();

  async function addHistory(q){
    const body = { u: currentUid(), q, engine: engineSel.value };
    try{
      await fetch("/api/history", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
    }catch{}
  }

  async function doSearch(){
    const q = (qInput.value || "").trim();
    if(!q) return;
    await addHistory(q);
    const url = currentEngine().url(q);
    window.open(url, "_blank", "noopener,noreferrer");
  }

  // --- events ---
  tabSuggest.addEventListener("click", ()=>setMode("suggest"));
  tabHistory.addEventListener("click", async ()=>{
    await loadHistoryToItems();
    setMode("history");
    showPanel();
  });

  $("#refreshHist").addEventListener("click", async ()=>{
    await loadHistoryToItems();
    setMode("history");
    showPanel();
  });

  $("#clearHist").addEventListener("click", async ()=>{
    const u = encodeURIComponent(currentUid());
    await fetch(`/api/history?u=${u}`, { method:"DELETE" }).catch(()=>{});
    await loadHistoryToItems();
    setMode("history");
    showPanel();
  });

  qInput.addEventListener("focus", () => debouncedSuggest());
  qInput.addEventListener("input", () => debouncedSuggest());

  qInput.addEventListener("keydown", (e)=>{
    if(!panel.classList.contains("show")) return;

    const show = (mode==="suggest")
      ? items.filter(x=>x.type!=="history")
      : items.filter(x=>x.type==="history");

    if(e.key==="ArrowDown"){
      e.preventDefault();
      active = Math.min(show.length-1, active+1);
      render();
    }else if(e.key==="ArrowUp"){
      e.preventDefault();
      active = Math.max(-1, active-1);
      render();
    }else if(e.key==="Enter"){
      e.preventDefault();
      if(active>=0) choose(active);
      else { hidePanel(); doSearch(); }
    }else if(e.key==="Escape"){
      hidePanel();
    }
  });

  document.addEventListener("click", (e)=>{
    if(!e.target.closest(".wrap")) hidePanel();
  });

  $("#go").addEventListener("click", ()=>doSearch());
  $("#clear").addEventListener("click", ()=>{
    qInput.value = "";
    qInput.focus();
    debouncedSuggest();
  });

  engineSel.addEventListener("change", ()=>{
    localStorage.setItem(LS_ENGINE, engineSel.value);
    debouncedSuggest();
  });

  uidInput.addEventListener("change", ()=>{
    localStorage.setItem(LS_UID, currentUid());
    debouncedSuggest();
  });

  // init
  (function init(){
    engineSel.innerHTML = ENGINES.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
    const savedEngine = localStorage.getItem(LS_ENGINE);
    engineSel.value = ENGINES.some(e=>e.id===savedEngine) ? savedEngine : "google";

    const savedUid = localStorage.getItem(LS_UID);
    uidInput.value = savedUid || "default";

    // 进来就展示历史（也符合 350px 内）
    loadHistoryToItems().then(()=>setMode("history"));
  })();
</script>
</body>
</html>
